@page "/login"
@using System.Text.Json
@using CaloriesTracker.Models
@using CaloriesTracker.Services
@inject Supabase.Client SupabaseClient
@inject IJSRuntime JS
@inject AuthService AuthService
@inject MealService MealService


<h3>Login or Sign Up</h3>

@if (user is not null)
{
    <p>Welcome, @user.Email!</p>
    <button class="btn btn-secondary" @onclick="HandleLogoutAsync">Logout</button>
}
else
{
    <input @bind="email" placeholder="Email" />
    <input @bind="password" type="password" placeholder="Password" />
    <button class="btn btn-primary" @onclick="HandleLoginAsync">Login</button>
    <button class="btn btn-secondary" @onclick="HandleSignUpAsync">Sign Up</button>
}

@code {
    [Inject]
    public required NavigationManager NavigationManager { get; set; }
    private Supabase.Gotrue.User? user;
    private string email = "";
    private string password = "";

    protected override async Task OnInitializedAsync()
    {
        user = await AuthService.GetCurrentUserAsync();
    }

    private async Task HandleLoginAsync()
    {
        try
        {
            user = await AuthService.LoginAsync(email, password);
            if (user != null)
                NavigationManager.NavigateTo(NavigationManager.BaseUri);
        }
        catch (Exception ex)
        {
            var error = JsonSerializer.Deserialize<SupabaseError>(ex.Message);
            await JS.InvokeVoidAsync("alert", "Error: " + error?.Message);
        }
    }

    private async Task HandleSignUpAsync()
    {
        try
        {
            user = await AuthService.SignUpAsync(email, password);
            if (user != null)
                NavigationManager.NavigateTo(NavigationManager.BaseUri);
        }
        catch (Exception ex)
        {
            var error = JsonSerializer.Deserialize<SupabaseError>(ex.Message);
            await JS.InvokeVoidAsync("alert", "Error: " + error?.Message);
        }
    }

    private async Task HandleLogoutAsync()
    {
        await AuthService.LogoutAsync();
        user = null;
    }
}
